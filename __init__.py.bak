from nonebot import on_message
from nonebot.adapters.onebot.v11 import MessageEvent, PrivateMessageEvent, GroupMessageEvent

from .logger import kchat_logger as logger
from .session_context import session_manager

# 注册消息处理器
message = on_message()

@message.handle()
async def handle_all_message(event: MessageEvent):
    """处理所有消息"""
    try:
        # 获取或创建会话并添加消息
        session = session_manager.get_session(event)
        session.add_message(event)

        # 记录成功信息
        session_info = {
            "session_id": session.session_id,
            "session_type": session.session_type,
            "message_count": len(session.messages)
        }

        if isinstance(event, PrivateMessageEvent):
            logger.success(f"私聊消息记录成功: {session_info}")
        elif isinstance(event, GroupMessageEvent):
            logger.success(f"群聊消息记录成功: {session_info}")
                
    except Exception as e:
        logger.opt(exception=e).error(f"消息处理失败: {str(e)}")

logger.opt(colors=True).success("<green>KChat 插件初始化完成</green>")
